import os
import geopandas as gpd
from shapely.ops import unary_union
from shapely.geometry import Polygon, MultiPolygon
import time

# ====== CEÄ»I ======
input_path = r"C:\Users\deniss.boka\Desktop\Boka_datuparbaude\Gatavie Shapefaili LKS 92\18. DAP Sugu noverojumi\DAP sugu noverojumi.shp"
output_folder = os.path.join(os.path.dirname(input_path), "Optimized_Dissolved")
os.makedirs(output_folder, exist_ok=True)

# ====== IESTATÄªJUMI ======
simplify_tolerance = 5.0   # lielÄka vÄ“rtÄ«ba = mazÄks fails, bet mazÄk detalizÄ“ts
default_crs = "EPSG:3059"  # LKS-92 Latvijai
target_crs = "EPSG:4326"   # Web koordinÄtas (WGS84)

# ====== FUNKCIJA ======
def safe_read_file(path):
    """DroÅ¡i ielasa shapefailu un pÄrliecinÄs, ka tas ir GeoDataFrame."""
    try:
        gdf = gpd.read_file(path)
    except Exception as e:
        raise RuntimeError(f"Nevar nolasÄ«t shapefailu: {e}")

    # Ja atgrieÅ¾as DataFrame â€” meklÄ“ Ä£eometrijas kolonnu
    if not isinstance(gdf, gpd.GeoDataFrame):
        from shapely import wkt
        geom_col = None
        for col in gdf.columns:
            if gdf[col].astype(str).str.startswith(("POLY", "MULTI")).any():
                geom_col = col
                break
        if geom_col:
            gdf[geom_col] = gdf[geom_col].apply(wkt.loads)
            gdf = gpd.GeoDataFrame(gdf, geometry=geom_col)
        else:
            raise ValueError("Nav atrasta Ä£eometrijas kolonna (geometry, Shape vai POLYGON dati).")

    return gdf


def optimize_and_dissolve(input_path):
    start = time.time()
    filename = os.path.basename(input_path)
    print(f"â¡ï¸ ApstrÄde sÄkta: {filename}")

    # 1ï¸âƒ£ Ielasa shapefailu droÅ¡Ä veidÄ
    gdf = safe_read_file(input_path)

    # 2ï¸âƒ£ PÄrbauda CRS
    if gdf.crs is None:
        print(f"âš ï¸ CRS nav norÄdÄ«ts â€” pieÅ¡Ä·ir {default_crs}")
        gdf.set_crs(default_crs, inplace=True)

    # 3ï¸âƒ£ Izmet nederÄ«gÄs rindas
    gdf = gdf[gdf.geometry.notnull() & gdf.is_valid].copy()
    if gdf.empty:
        raise ValueError("Shapefails nesatur derÄ«gas Ä£eometrijas!")

    # 4ï¸âƒ£ NoÅ†em liekÄs kolonnas (fid, id, shape_area utt.)
    drop_cols = [c for c in gdf.columns if c.lower() in ["fid", "id", "objectid", "shape_area", "shape_leng"]]
    gdf.drop(columns=drop_cols, inplace=True, errors="ignore")

    # 5ï¸âƒ£ NoÅ†em konstantes kolonnas
    gdf = gdf.loc[:, gdf.nunique() > 1]

    # 6ï¸âƒ£ PÄrprojektÄ“ uz WGS84
    gdf = gdf.to_crs(target_crs)

    # 7ï¸âƒ£ VienkÄrÅ¡o (pirms apvienoÅ¡anas)
    gdf["geometry"] = gdf["geometry"].simplify(simplify_tolerance, preserve_topology=True)

    # 8ï¸âƒ£ Apvieno (dissolve visus)
    print("ğŸ§© Apvieno Ä£eometrijas (var aizÅ†emt lÄ«dz 1 min)...")
    merged_geom = unary_union(gdf.geometry)

    if isinstance(merged_geom, Polygon):
        merged_geom = MultiPolygon([merged_geom])

    # 9ï¸âƒ£ Jaunais GeoDataFrame
    result = gpd.GeoDataFrame(geometry=[merged_geom], crs=target_crs)

    # ğŸ”Ÿ PÄ“dÄ“jÄ vienkÄrÅ¡oÅ¡ana â€“ vÄ“l samazina izmÄ“ru
    result["geometry"] = result["geometry"].simplify(simplify_tolerance * 1.5, preserve_topology=True)

    # ğŸ”¸ SaglabÄ rezultÄtu
    out_name = os.path.splitext(filename)[0] + "_merged_light.gpkg"
    out_path = os.path.join(output_folder, out_name)
    result.to_file(out_path, driver="GPKG")

    # ğŸ“Š InformÄcija
    elapsed = round(time.time() - start, 2)
    orig_size = os.path.getsize(input_path) / (1024 * 1024)
    new_size = os.path.getsize(out_path) / (1024 * 1024)
    reduction = (1 - new_size / orig_size) * 100
    print(f"âœ… SaglabÄts: {out_name} ({elapsed} s)")
    print(f"ğŸ“‰ IzmÄ“rs: {orig_size:.1f} MB â†’ {new_size:.1f} MB ({reduction:.1f}% mazÄks)\n")


# ====== IZPILDE ======
try:
    optimize_and_dissolve(input_path)
except Exception as e:
    print(f"âŒ KÄ¼Å«da: {e}")
